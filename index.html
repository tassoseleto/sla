<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema AdOps - Adseleto</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div id="app">
        <div class="max-w-7xl mx-auto px-4 py-8">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Sistema de Logs AdOps</h1>
                <p class="text-gray-600">Registro de altera√ß√µes - Adseleto</p>
            </div>

            <!-- Filtro AdOps -->
            <div class="mb-6 bg-white p-4 rounded-lg shadow">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Filtrar por AdOps (apenas na sua m√°quina)
                </label>
                <div class="flex gap-4">
                    <input
                        type="text"
                        id="filterAdOps"
                        placeholder="Digite seu nome para ver apenas seus logs..."
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    />
                    <button onclick="clearFilter()" class="text-red-500 hover:text-red-700 px-3">
                        Limpar
                    </button>
                </div>
            </div>

            <!-- Dashboard -->
            <div class="mb-6 bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-4">Progresso dos Testes</h3>
                
                <div class="mb-4">
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>Testes Completados</span>
                        <span id="progressText">0/0 (0%)</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="progressBar" class="bg-green-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-4">
                    <div class="text-center">
                        <div id="totalCount" class="text-2xl font-bold text-gray-900">0</div>
                        <div class="text-sm text-gray-600">Total</div>
                    </div>
                    <div class="text-center">
                        <div id="progressCount" class="text-2xl font-bold text-yellow-600">0</div>
                        <div class="text-sm text-gray-600">Em Progresso</div>
                    </div>
                    <div class="text-center">
                        <div id="completedCount" class="text-2xl font-bold text-green-600">0</div>
                        <div class="text-sm text-gray-600">Completados</div>
                    </div>
                    <div class="text-center">
                        <div id="blockedCount" class="text-2xl font-bold text-red-600">0</div>
                        <div class="text-sm text-gray-600">Bloqueados</div>
                    </div>
                </div>
            </div>

            <!-- Bot√µes -->
            <div class="mb-6 flex gap-4">
                <button onclick="showForm()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    ‚ûï Novo Log
                </button>
                <input
                    type="text"
                    id="searchInput"
                    placeholder="Buscar..."
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    oninput="filterLogs()"
                />
            </div>

            <!-- Formul√°rio -->
            <div id="logForm" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
                <h2 class="text-xl font-semibold mb-4">Novo Log</h2>
                <form onsubmit="saveLog(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Site *</label>
                            <input type="text" id="site" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="exemplo.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Owner (AdOps) *</label>
                            <input type="text" id="owner" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Seu nome">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pa√≠s</label>
                            <select id="pais" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="">Selecione...</option>
                                <option value="Brasil">Brasil</option>
                                <option value="EUA">EUA</option>
                                <option value="M√©xico">M√©xico</option>
                                <option value="Argentina">Argentina</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="In progress">Em Progresso</option>
                                <option value="Completed">Completado</option>
                                <option value="Analyzed">Analisado</option>
                                <option value="Blocked">Bloqueado</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Altera√ß√£o *</label>
                        <select id="alteracoes" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Selecione...</option>
                            <option value="Bloqueio de Criativos">Bloqueio de Criativos</option>
                            <option value="Bloqueio de Categoria">Bloqueio de Categoria</option>
                            <option value="Implementa√ß√£o de Tags">Implementa√ß√£o de Tags</option>
                            <option value="Configura√ß√£o Header Bidding">Configura√ß√£o Header Bidding</option>
                            <option value="Configura√ß√£o AdSense">Configura√ß√£o AdSense</option>
                            <option value="Debug e Corre√ß√µes">Debug e Corre√ß√µes</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Observa√ß√µes</label>
                        <textarea id="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Observa√ß√µes..."></textarea>
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            Salvar Log
                        </button>
                        <button type="button" onclick="hideForm()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>

            <!-- Lista de Logs -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div id="logsContainer">
                    <div class="p-12 text-center">
                        <div class="text-6xl mb-4">üìã</div>
                        <div class="text-gray-400 text-lg mb-2">Nenhum log encontrado</div>
                        <p class="text-gray-500">Comece criando seu primeiro log!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    let logs = JSON.parse(localStorage.getItem('adopsLogs') || '[]');
    
    // URL do seu Google Apps Script
    const SHEETS_URL = 'https://script.google.com/macros/s/AKfycbzMZhijsFYjGc8dVFVfJbVHt1vFOtmkrN6nGR650CheOOdkYEHP63roCbPDt8eYC1297A/exec';
    
    // Carregar dados do Google Sheets
    async function loadFromSheets() {
        try {
            console.log('Carregando dados do Google Sheets...');
            const response = await fetch(SHEETS_URL + '?action=get', {
                method: 'GET',
                mode: 'cors'
            });
            
            if (!response.ok) throw new Error('Erro na conex√£o');
            
            const data = await response.json();
            console.log('Dados recebidos:', data);
            
            // Processar dados vindos do Sheets
            const processedLogs = data.map(row => ({
                id: row.id || Date.now(),
                site: row.site || '',
                owner: row.owner || '',
                pais: row.pais || row.pa√≠s || '',
                status: row.status || 'In progress',
                alteracoes: row.alteracoes || row.altera√ß√µes || '',
                notes: row.notes || '',
                createdAt: row.createdat || row.datahora || new Date().toLocaleString('pt-BR')
            })).filter(log => log.site); // Remove linhas vazias
            
            logs = processedLogs;
            localStorage.setItem('adopsLogs', JSON.stringify(logs));
            renderLogs();
            updateStats();
            
            console.log('‚úÖ Dados carregados do Google Sheets');
            
        } catch (error) {
            console.error('‚ùå Erro ao carregar do Google Sheets:', error);
            console.log('üì± Usando dados locais');
        }
    }
    
    // Salvar no Google Sheets
    async function saveToSheets(logData) {
        try {
            console.log('Enviando para Google Sheets:', logData);
            
            const response = await fetch(SHEETS_URL, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'add',
                    ...logData
                })
            });
            
            if (!response.ok) throw new Error('Erro ao salvar');
            
            const result = await response.json();
            console.log('‚úÖ Salvo no Google Sheets:', result);
            
            return true;
            
        } catch (error) {
            console.error('‚ùå Erro ao salvar no Google Sheets:', error);
            console.log('üì± Dados salvos apenas localmente');
            return false;
        }
    }
    
    function showForm() {
        document.getElementById('logForm').classList.remove('hidden');
    }
    
    function hideForm() {
        document.getElementById('logForm').classList.add('hidden');
        document.querySelector('form').reset();
    }
    
    async function saveLog(event) {
        event.preventDefault();
        
        const newLog = {
            id: Date.now(),
            site: document.getElementById('site').value,
            owner: document.getElementById('owner').value,
            pais: document.getElementById('pais').value,
            status: document.getElementById('status').value,
            alteracoes: document.getElementById('alteracoes').value,
            notes: document.getElementById('notes').value,
            createdAt: new Date().toLocaleString('pt-BR')
        };
        
        // Salvar localmente primeiro
        logs.unshift(newLog);
        localStorage.setItem('adopsLogs', JSON.stringify(logs));
        
        // Tentar salvar no Google Sheets
        const savedOnline = await saveToSheets(newLog);
        
        hideForm();
        renderLogs();
        updateStats();
        
        if (savedOnline) {
            alert('‚úÖ Log salvo com sucesso no Google Sheets!');
        } else {
            alert('‚ö†Ô∏è Log salvo localmente. Ser√° sincronizado quando a conex√£o melhorar.');
        }
    }
    
    function deleteLog(id) {
        if (confirm('Tem certeza que deseja excluir?')) {
            logs = logs.filter(log => log.id !== id);
            localStorage.setItem('adopsLogs', JSON.stringify(logs));
            renderLogs();
            updateStats();
        }
    }
    
    function clearFilter() {
        document.getElementById('filterAdOps').value = '';
        localStorage.removeItem('currentAdOps');
        filterLogs();
    }
    
    function filterLogs() {
        const adopsFilter = document.getElementById('filterAdOps').value.toLowerCase();
        const searchFilter = document.getElementById('searchInput').value.toLowerCase();
        
        localStorage.setItem('currentAdOps', adopsFilter);
        
        const filtered = logs.filter(log => {
            const matchesAdOps = !adopsFilter || log.owner.toLowerCase().includes(adopsFilter);
            const matchesSearch = !searchFilter || 
                log.site.toLowerCase().includes(searchFilter) ||
                log.alteracoes.toLowerCase().includes(searchFilter) ||
                log.owner.toLowerCase().includes(searchFilter);
            return matchesAdOps && matchesSearch;
        });
        
        renderFilteredLogs(filtered);
        updateStatsForFiltered(filtered);
    }
    
    function renderLogs() {
        filterLogs();
    }
    
    function renderFilteredLogs(logsToRender) {
        const container = document.getElementById('logsContainer');
        
        if (logsToRender.length === 0) {
            container.innerHTML = `
                <div class="p-12 text-center">
                    <div class="text-6xl mb-4">üìã</div>
                    <div class="text-gray-400 text-lg mb-2">Nenhum log encontrado</div>
                    <p class="text-gray-500">Comece criando seu primeiro log!</p>
                </div>
            `;
            return;
        }
        
        const tableHtml = `
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Altera√ß√µes</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Site</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Owner</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${logsToRender.map(log => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 text-sm">
                                    <div class="font-medium text-gray-900">${log.alteracoes}</div>
                                    ${log.notes ? `<div class="text-gray-500 text-xs mt-1">${log.notes.substring(0, 50)}${log.notes.length > 50 ? '...' : ''}</div>` : ''}
                                </td>
                                <td class="px-6 py-4 text-sm font-medium text-gray-900">${log.site}</td>
                                <td class="px-6 py-4 text-sm text-gray-900">${log.owner}</td>
                                <td class="px-6 py-4">
                                    <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(log.status)}">
                                        ${log.status}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-500">${log.createdAt}</td>
                                <td class="px-6 py-4">
                                    <button onclick="deleteLog(${log.id})" class="text-red-600 hover:text-red-800 text-xs">
                                        üóëÔ∏è Excluir
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        container.innerHTML = tableHtml;
    }
    
    function getStatusColor(status) {
        switch(status) {
            case 'Completed': return 'bg-green-100 text-green-800';
            case 'Analyzed': return 'bg-blue-100 text-blue-800';
            case 'Blocked': return 'bg-red-100 text-red-800';
            default: return 'bg-yellow-100 text-yellow-800';
        }
    }
    
    function updateStats() {
        const adopsFilter = document.getElementById('filterAdOps').value.toLowerCase();
        const filteredLogs = adopsFilter ? 
            logs.filter(log => log.owner.toLowerCase().includes(adopsFilter)) : 
            logs;
        updateStatsForFiltered(filteredLogs);
    }
    
    function updateStatsForFiltered(filteredLogs) {
        const total = filteredLogs.length;
        const completed = filteredLogs.filter(log => log.status === 'Completed' || log.status === 'Analyzed').length;
        const inProgress = filteredLogs.filter(log => log.status === 'In progress').length;
        const blocked = filteredLogs.filter(log => log.status === 'Blocked').length;
        const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
        
        document.getElementById('totalCount').textContent = total;
        document.getElementById('completedCount').textContent = completed;
        document.getElementById('progressCount').textContent = inProgress;
        document.getElementById('blockedCount').textContent = blocked;
        document.getElementById('progressText').textContent = `${completed}/${total} (${percentage}%)`;
        document.getElementById('progressBar').style.width = `${percentage}%`;
    }
    
    // Adicionar bot√£o para sincronizar manualmente
    function addSyncButton() {
        const buttonsDiv = document.querySelector('.mb-6.flex.gap-4');
        const syncButton = document.createElement('button');
        syncButton.innerHTML = 'üîÑ Sincronizar';
        syncButton.className = 'bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700';
        syncButton.onclick = loadFromSheets;
        buttonsDiv.appendChild(syncButton);
    }
    
    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('filterAdOps').addEventListener('input', filterLogs);
        
        // Carregar dados salvos
        const savedAdOps = localStorage.getItem('currentAdOps');
        if (savedAdOps) {
            document.getElementById('filterAdOps').value = savedAdOps;
        }
        
        // Adicionar bot√£o de sincroniza√ß√£o
        addSyncButton();
        
        // Carregar dados do Google Sheets
        loadFromSheets();
        
        renderLogs();
        updateStats();
    });
</script>
</body>
</html>
